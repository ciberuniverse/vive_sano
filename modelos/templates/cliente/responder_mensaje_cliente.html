{% extends 'base.html' %}

{% block contenido %}
<div class="container mt-4">
  <h5 class="fw-bold mb-3">Responder mensaje</h5>

  <div class="card shadow-sm mb-4">
    <div class="card-body">

      {% if codigo %}
        <div class="alert alert-warning text-center mb-0">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          Nada por aquí. No se encontró un mensaje para responder.
        </div>
      {% else %}
        <form method="POST" action="/mis-pedidos/{{ pedido_id }}/mensajes/responder/" class="row g-3">
          {% csrf_token %}

          <!-- Campo de texto -->
          <div class="col-12">
            <label for="mensaje" class="form-label">Tu respuesta</label>
            <textarea name="mensaje" id="mensaje" class="form-control" rows="4"
                      placeholder="Escribe tu mensaje aquí..."></textarea>
          </div>

          <!-- Botón de envío -->
          <div class="col-12 text-end">
            <button class="btn btn-success">
              <span class="material-symbols-outlined align-middle">send</span>
              <span class="align-middle">Enviar respuesta</span>
            </button>
          </div>
        </form>
      {% endif %}

    </div>
  </div>

  <!-- Historial de mensajes -->
  <h5 class="fw-bold mb-3">Historial de mensajes</h5>
  {% if mensajes %}
<ul class="list-group">
  {% for mensaje in mensajes %}
    <li class="list-group-item">
      <!-- Encabezado con tipo y fecha -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong class="text-primary">{{ mensaje.get_tipo_display }}</strong>
        <small class="text-muted">{{ mensaje.fecha_envio|date:"d/m/Y H:i" }}</small>
      </div>

      <!-- Mensaje principal -->
      <p class="mb-2">{{ mensaje.mensaje }}</p>

      <!-- Respuesta (si existe) -->
      {% if mensaje.respuesta_texto %}
        <div class="border rounded p-2 mb-2 bg-light">
          <span class="badge 
            {% if mensaje.estado_respuesta == 'ACEPTADO' %}bg-success
            {% elif mensaje.estado_respuesta == 'RECHAZADO' %}bg-danger
            {% else %}bg-secondary{% endif %}">
            {{ mensaje.get_estado_respuesta_display }}
          </span>
          <p class="mb-1"><small><strong>Respuesta:</strong> {{ mensaje.respuesta_texto }}</small></p>
          <small class="text-muted">Fecha respuesta: {{ mensaje.fecha_respuesta|date:"d/m/Y H:i" }}</small>
        </div>
      {% endif %}

      <!-- Información adicional -->
      <small class="d-block text-muted mb-2">
        Remitente: {{ mensaje.remitente|default:"-" }} |
        Destinatario: {{ mensaje.destinatario|default:"-" }} |
        Fecha envío: {{ mensaje.fecha_envio|date:"d/m/Y H:i" }}
      </small>


    </li>
  {% endfor %}
</ul>

  {% else %}
    <div class="alert alert-info text-center">
      No hay mensajes registrados para este pedido.
    </div>
  {% endif %}
</div>
{% endblock %}
