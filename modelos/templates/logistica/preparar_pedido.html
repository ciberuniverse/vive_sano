{% extends "base.html" %}
{% block contenido %}
<div class="container mt-4">
  <h2 class="mb-4">Preparar Pedido #{{ pedido.id }}</h2>

  <form method="post" class="card shadow-sm p-4">
    {% csrf_token %}
    {{ form.pedido_id }}

    <div class="mb-3">
      <label class="form-label">Estado</label>
      {{ form.estado }}
    </div>
    <div class="mb-3">
      <label class="form-label">Tiempo despacho</label>
      {{ form.tiempo_despacho }}
    </div>
    <div class="mb-3">
      <label class="form-label">Almacenamiento especial</label>
      {{ form.almacenamiento_especial }}
    </div>
    <div class="mb-3">
      <label class="form-label">Observaciones</label>
      {{ form.observaciones }}
    </div>

    <h4>Solicitados</h4>
    <ul class="list-group mb-4">
        {% for d in detalles %}
        <li class="list-group-item d-flex justify-content-between">
            <span>{{ d.producto.nombre }} (x{{ d.cantidad }})</span>
            <span>${{ d.precio_unitario }}</span>
        </li>
        {% endfor %}
    </ul>

    <h3 class="mt-4">Seleccionar productos para preparar</h3>
    <p class="text-muted">Revisa stock y define cantidades. Al guardar, descontará stock disponible.</p>

    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>Producto</th>
          <th>Stock</th>
          <th>Cantidad a enviar</th>
        </tr>
      </thead>
      <tbody>
        {% for p in productos %}
        <tr>
          <td>{{ p.nombre }}</td>
          <td>{{ p.stock }}</td>
          <td>
            <input type="number" min="0" value="0" data-producto-id="{{ p.id }}" class="form-control cantidad-input">
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

  <div class="btn btn-warning" width="100px" onclick="window.location.href='/logistica/pedido/{{ pedido.id }}/notificar/'">
    Notificar un Suceso
  </div>
  <br>
    <input type="hidden" name="productos" id="productos-field" />
    <button type="submit" onclick="packProductos(event)" class="btn btn-success w-100">
      Guardar
    </button>
  </form>

  <p class="mt-3">
    <a href="" class="btn btn-outline-secondary">Volver al detalle</a>
  </p>
</div>

<script>
function packProductos(event){
  // antes de enviar, convertir inputs en JSON y colocarlo en el campo hidden
  var rows = document.querySelectorAll('.cantidad-input');
  var arr = [];
  rows.forEach(function(inp){
    var qty = parseInt(inp.value) || 0;
    var pid = inp.getAttribute('data-producto-id');
    if(qty > 0){
      arr.push({producto_id: pid, cantidad: qty});
    }
  });
  document.getElementById('productos-field').value = JSON.stringify(arr);
  // el form seguirá el submit normal
}
</script>
{% endblock %}
